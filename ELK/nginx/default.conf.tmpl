server {
  listen 80;

  server_name {{ default .Env.KOPF_SERVER_NAME "es.dev" }};

  satisfy any;

  {{ if .Env.KOPF_BASIC_AUTH_LOGIN }}
  auth_basic "Access restricted";
  auth_basic_user_file /etc/nginx/kopf.htpasswd;
  {{ end }}

  {{ if .Env.KOPF_NGINX_INCLUDE_FILE }}
  include {{ .Env.KOPF_NGINX_INCLUDE_FILE }};
  {{ end }}

  # suppress passing basic auth to upstreams
  proxy_set_header Authorization "";

  # everybody loves caching bugs after upgrade
  expires -1;

  location / {
    proxy_pass http://{{ default .Env.KOPF_ES_SERVERS "es:9200" }}/_plugin/kopf$request_uri;
  }
